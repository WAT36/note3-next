---
title: 'Cognito(AWS)'
excerpt: 'AWSのCognitoについて'
coverImage: '/assets/posts/cognito/cognitologo.png'
date: '2023-02-10T22:16:12.000Z'
updatedAt: '2023-02-10T22:16:12.000Z'
tag: ["AWS","Cognito"]
author:
  name: Tatsuroh Wakasugi
  picture: '/assets/blog/authors/WAT.jpg'
ogImage:
  url: ''
---

認証、認可を行うにあたり、AWSのサービス「Cognito」について調べてみたので、ここに書き留めておく。

# Cognitoとは

Cognitoとは、「認証・認可」の機能を提供するAWSのサービスであり、主にWebアプリケーションやモバイルアプリケーションに認証機能を提供する用途で利用される。
このサービスにより素早く簡単にユーザーのサインアップ/サインインおよびアクセスコントロールの機能を追加できる。

またCognito は、Apple、Facebook、Google、Amazon などのソーシャル ID プロバイダー、SAML 2.0 および OpenID Connect によるエンタープライズ ID プロバイダーを使用したサインインをサポートしている。

# Cognitoのコンポーネント

Cognito は主に **ユーザープール** と **ID プール** と呼ばれる2 つのコンポーネントからなる。
ユーザープールは、アプリユーザーのサインアップとサインインオプションを提供するユーザーディレクトリである。
ID プールは、AWS の他のサービスに対するアクセスをユーザーに許可します。ID プールとユーザープールは別々に使用することも、一緒に使用することもできる。 

利用者が自分でユーザーを登録できるのはもちろん、管理者が事前登録したり、CSVファイルからのインポートやLambdaを使ったユーザー移行などにも対応している。

また、作成できるユーザーの上限数についてもデフォルトで20,000,000と、不特定多数の一般ユーザーを管理するのに十分なものとなっている。

Cognitoの大きなコンポーネントである「ユーザープール」と「IDプール」についてを示す。

## ユーザープール

ユーザープールはユーザーの **認証** と **管理** を行うコンポーネントである。
ユーザー認証の方式として、以下の2通りが用意されている。

1. Cognitoユーザープールが提供する認証機能
2. 外部IDプロバイダーと連携した認証

ユーザー名/パスワードで認証されたユーザー、外部IDプロバイダーと連携して認証されたユーザーは、共にユーザープール内で「ユーザー」として登録され、同列に扱われる。
ユーザープールでユーザー認証が行われると、認証された証として「IDトークン」が発行される。
このIDトークンを使って、アプリケーションがユーザーを特定したり、他のサービスとの連携を行ったりすることができる。
大体は、後述するIDプールと組み合わせて行うことが多い。

### Cognitoユーザープールが提供する認証機能

ユーザー名 (設定によってメールアドレスや電話番号も使用可能) とパスワードを入力してログイン認証を行う。
ユーザーは、管理者が事前に作成しておくことも、ユーザー自身が「サインアップ」を行い登録することもできる。
サインアップによってユーザー登録を行う場合は、メールアドレスまたは電話番号を使った本人確認 (Confirm) が行われる。

![](/assets/posts/cognito/userpool.png)

### 外部IDプロバイダーと連携した認証

Webアプリケーションやモバイルアプリケーションでユーザー名やパスワードの入力を求めるのではなく、外部のIDプロバイダーが提供するログイン画面を利用する。
連携可能な外部IDプロバイダーとしては「Facebook」「Google」「Amazon」「Apple」が提供する認証サービスが対応している。 (これらは「ソーシャルIDプロバイダー」とも呼ばれる)
これら以外にも、認証プロトコルの標準である「SAML」や「OIDC (Open ID Connector)」に対応した認証サービスとも連携が可能になる。
外部IDプロバイダーと連携した認証では、ユーザープールに対する明示的なユーザー登録は行わず、初めて認証が行われた時にユーザーが登録される。
Cognitoユーザープールと上記の外部IDプロバイダーとを連携させることで、ユーザーは該当のIDプロバイダーを使った認証を利用することができ、また認証されるとユーザープールにその情報を登録することができる。

![](/assets/posts/cognito/userpool_social.png)

## IDプール

IDプールは、外部の「IDプロバイダー」によって認証されたIDに対して、AWSへのアクセス権限を持つ「一時クレデンシャル」を払い出すことができるコンポーネントである。
AWSへのアクセス権限を提供することから、ユーザへの **認可** を行うコンポーネントと説明されることもある。
IDプールが認証のために利用できるIDプロバイダーは、以下の通り。

- Cognitoユーザープール
- Amazon
- Facebook
- Google
- Twitter
- OIDCに準拠したプロバイダー
- SAMLに準拠したプロバイダー

IDプールにより認可が行えると、一時的なAWS認証情報(STS)を取得する事ができ、これにより他のAWSサービスを利用する事ができる。

利用できるサービスは、S3やDynamoDBといったAWSサービスである事が多い。

![](/assets/posts/cognito/idpool_flow.png)
