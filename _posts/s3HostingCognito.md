---
title: 'S3静的ホスティングサイト + Cognito認証'
excerpt: 'S3での静的Webホスティングで立てたサイトにCognitoによる認証を付ける'
coverImage: ''
date: '2023-02-16T22:29:57.000Z'
updatedAt: '2023-02-16T22:29:57.000Z'
tag: ["AWS","S3","Cognito"]
author:
  name: Tatsuroh Wakasugi
  picture: '/assets/blog/authors/WAT.jpg'
ogImage:
  url: ''
draft: true
---

前述の S3の静的Webサイトホスティング で立てたWebサイトに、 また前述のCognito による認証を付け加えて、限られたユーザしか閲覧できないようにする。

# S3による静的Webサイトホスティング

こちらは前述の記事を参照されたし。
ここでは割愛する。

# Cognito

次に認証基盤となる、Cognitoの設定を行う。

## ユーザープールの作成

まずは閲覧できるユーザーの管理を行うユーザープールを作成する。
今回は、ユーザーの登録は管理側で行うものとし、サイナップは行えないようにする。

- cognitoコンソールへ行く
- まずは「ユーザープールの作成」へ
- プロバイダーのタイプは「Cognitoユーザープール」で、サインインオプションはユーザー名だけにしておく、とりあえず
- ユーザー名の要件も任意のユーザー名でサインインすることを許可、大文字小文字区別にチェック入れる
- 次はステップ２のセキュリティ要件
- パスワードポリシーはCognitoのデフォルト
- MFAはなしでいい
- ユーザアカウントの復旧はとりあえず　セルフサービスのアカウントの復旧を有効化　にしておく
- 次はステップ３　サインアップエクスペリエンス
- セルフサービスのサインアップ　で自己登録の有効化　をつける　→ これは**なし**。 **"管理者のみにユーザーの作成を許可する"** がいいのでは
- 属性検証とユーザーアカウントの確認　で、、　とりあえず推奨の通り　なんか違うと思うが。。
 - ユーザーアカウントの復旧 セルフサービスのアカウントの復旧　は今回はなし
 - Cognito が検証と確認のためにメッセージを自動的に送信することを許可 今回はなしでいい
- 属性変更の確認　ここもとりあえず推奨で
- ユーザー作成時の必須の属性を選択 まあとりあえずemailのみ
- 次にステップ４　メッセージ配信の設定
- Eメールプロバイダー　とりあえずCognitoからで
- 送信元アドレスもデフォルトで次へ
- 次はステップ５　アプリケーションの統合
- ユーザープール名の設定　をする
- ホストされた認証ページ　これって必要？　必要そうな気がするが、、　後で調べる　→ **多分必要**
- 最初のアプリケーションクライアント　パブリッククライアント　で　アプリケーションクライアント名を入力
- クライアントシークレットを生成しない　を設定
- で次へ
- 最後ステップ６確認及び作成
- でユーザープールのお作成　へ
- でユーザープールが作成される

- ユーザープールが作成されたら　アプリケーションの統合＞アプリクライアントと分析＞アプリケーションクライアント名
- アプリケーションクライアント名　を入力
- ホストされたUI　で編集
- IDプロバイダー　でCognitoユーザープールを選択
- "コールバック URL"、"サインアウト URL" を HTTPS で設定する。ここではコールバックURLは S3 バケットにある index.html の オブジェクト URL 、サインアウトURLはgoogleなどを入れる。
- ↑ **（S3の静的webホスティングでHTTPS化しておく必要がある！！）** 
- OAuth2.0許可タイプ　は暗黙的な付与
- OpenID接続スコープ　はOpenIDを入れる
- で変更の保存

- アプリケーションの統合＞ドメイン名　でCognitoドメインの作成　をする、名前も入力する

- そのあと、以下にアクセスして、ログイン画面が出てくるか確認する
(CognitoドメインのURL)/login?response_type=token&client_id=(アプリクライアント ID)&redirect_uri=(コールバック URL)

そのあと、認証用のユーザーを作成する。

- コンソールで、該当のユーザープールから「ユーザーの作成」
- ユーザー名　でユーザー名を入力する。
- 仮パスワードの設定、入力する
- で確定

- 作成後、先ほどのログインURLに行き、ユーザ名とパスワードを入力
- 仮パスワード入力後、本パスワードに変更するよう求められるので入力（この時Emailも求められたが、、設定ミスったか）
- すると入れる　はず

## S3パブリックアクセスを無効にする

今のこの状態だとS3が誰でも見える状態なので、認証されたユーザ以外見れないようにまずS3のパブリックアクセスを無効化させる。

- コンソールからS3へ行き、g該当のバケットへ
- アクセス許可　からブロックパブリックアクセス　を参照し、パブリックアクセスをオンにする

- バケットポリシーで、トップページだけアクセス可能にし他はできないようにする（以下のような設定）

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "PublicReadGetObject",
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::(バケット名)/index.html"
        }
    ]
}
```

また、S3でCORSの設定に以下のJSONを設定する。

```json
[
    {
        "AllowedHeaders": [
            "*"
        ],
        "AllowedMethods": [
            "GET",
            "HEAD"
        ],
        "AllowedOrigins": [
            "*"
        ],
        "ExposeHeaders": []
    }
]
```


## IDプールの作成

次にIDプールの作成を行う。認証gが通ったユーザーに対し、S3への読み取り権限を行えるロールを付与する。

- AWSマネジメントコンソールからCognitoへ
- 「IDプールの作成」へ行く
- IDプール名を入力
- 「認証されてないID」の「認証されてないIDに対してアクセスを有効にする」をオンにする
- 「認証プロバイダー」には、作成したCognitoユーザープールIDとアプリクライアントIDを入力する。
- で「プールの作成」
- すると認証成功時に付与されるIAMロールの設定画面がでる
- ここで、対象バケットが見れるようなIAMロールを指定する。新しく作成する場合、インラインで以下

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "s3:ListBucket",
            "Resource": "arn:aws:s3:::(バケット名)"
        },
        {
            "Effect": "Allow",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::(バケット名)/*"
        }
    ]
}
```

- 入力したら許可
