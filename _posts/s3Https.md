---
title: 'ドメインを取得してS3(静的Webホスティング)をHTTPS化する'
excerpt: 'AWSでのドメイン取得方法・S3に立てたWebサイトをHTTPS化する手順'
coverImage: '/assets/posts/s3Https/httpsProcess.png'
date: '2023-02-14T23:03:11.000Z'
updatedAt: '2023-02-14T23:03:11.000Z'
tag: ["AWS","S3","ACM","CloudFront","HTTP","HTTPS","Route53","DNS","ドメイン"]
author:
  name: Tatsuroh Wakasugi
  picture: '/assets/blog/authors/WAT.jpg'
ogImage:
  url: ''
draft: false
---

前述の [S3に立てた静的Webサイト](/posts/s3StaticHost) の記事であるが、S3静的Webホスティングでサイトを建てた時、通常ではHTTPでのアクセス、表示となっている。

また、S3静的Webサイトホスティングを設定した場合、公開URLの形式は固定されている。

自分で設定したURLで公開したい場合、またHTTPS化して通信したいとなった時どうすれば良いか。今回はその実施を行ってみたので、そのための手順を留めておく。

# HTTPSとは

の前に、まずHTTPSとは何なんだろうか。

## HTTP

まず前提として、ユーザーがWebブラウザを通して、Webサイトのあるサーバからサイトのデータをやり取りするためのプロトコル(通信規則)として**HTTP** がある。

流れとしては、ユーザーがWebブラウザから指定したWebサイトを開こうとすると、そのWebサイトがあるWebサーバーにリクエストが送信される。Webサーバー側はそのリクエストを受信し、そのWebサイトを構成するデータ(htmlファイルなど)をユーザー側にレスポンスとして返す。そのレスポンスをWebブラウザが受け取り、Webサイトを表示するという仕組みになっている。

![](/assets/posts/s3Https/http.png)

## HTTPS

しかし、このHTTPでは、リクエストとレスポンスは暗号化されておらず、他の第三者が通信を傍受し、内容を覗き見るとどのようなデータが送られているかがわかってしまう状態になってしまう。

特に重大な情報を送ってないのであれば良いのだが、例えば決済を行うサイトの場合は自分のクレジットカード情報やパスワードだったり、個人情報を利用するサイトでは自分の個人情報を送るパターンもある。そのような場合、他の第三者に内容がわかってしまう状態で送るのは良くないだろう。

このような場合の対策として、HTTPに暗号化を施して送受信する仕組みが**HTTPS**である。HTTPSで送受信した場合、データが暗号化されるため、第三者に通信を傍受されても内容が解読できず読み取られない。

## HTTPSの設定

HTTPSを設定するためには何を用意すれば良いか。

HTTPSの暗号化設定は、**SSLサーバ証明書**を利用する事で実現できる。

SSLサーバ証明書とは、ユーザ(Webブラウザ)とWebサーバ間で通信の暗号化を行うための電子証明書であり、ユーザ・サーバとは別の外部の**認証局**から発行される。

認証局とは、対象のWebサイトの正当性を示すための第三者機関であり、Webサイトの審査を行い、正当性が確認できたら証明書の発行を行う。

このSSLサーバ証明書には、Webサイトの情報、及び暗号化に必要な鍵などのデータが含まれており、これを利用してHTTPS通信を行う。

![](/assets/posts/s3Https/certificate.png)

このうちの認証局について、実はAWSには認証局の役割を行えるサービス「**AWS Certificate Manager**」がある。今回はそちらを使用しつつ行っていく。

# ドメインとは

インターネットで言うドメインとは、いわゆるWeb上での住所のことを言う。

正確にはWeb上での住所のことは「IPアドレス」と言う数字列で示されるのだが、数字列だとわかりにくいため、人間がわかりやすいような文字列で置き換える(DNS と言う仕組みを用いる)ことが多い。この文字列がドメイン名である。

ちなみにこのブログは「wat-notes.com」と言うドメイン名を設定している。

このドメイン名だが、実は自由に設定できると言うわけではなく、世界で一意でなければならない。

また、ドメイン名の登録には料金がかかる。ドメイン名の登録や購買は専用のサービスがあるのでそちらを利用して行う。

ちなみにAWSでは、DNSの設定を行うサービス「Route 53」があるので、今回はこちらを使用する。また、このRoute53により、ドメイン名の登録・購入も行える。

# 静的Webへのドメイン取得・HTTPS化の手順

大まかな手順としては以下の通り。なおS3での静的Webホスティングは既に行われている前提である。
- Route53で独自ドメインを設定（別サービスでドメインを取得しているなら飛ばす）
- ACMで証明書を作成する
- CloudFrontでディストリビューションを作成し、S3の静的Webサイトと結びつけ、また証明書も適用する

![](/assets/posts/s3Https/httpsProcess.png)

# Route53でドメインを取得する

まずは、HTTPS化に必要なドメイン名の登録を行っておく。

(既に別の方法でドメインの取得を行っている場合、ここは不要。)

1. マネジメントコンソールからRoute53のページへ

![](/assets/posts/s3Https/domain01.png)

2. 「ドメインの登録」へ
3. ドメイン名と、トップレベルドメイン(.comなど)を入力する
4. 「チェック」を押して、登録可能か確認する
5. 決めたら「カートに入れる」を押して「続行」

![](/assets/posts/s3Https/domain02.png)

6. 「ドメインのお問い合わせ」で連絡先を書く

![](/assets/posts/s3Https/domain03.png)

7. 最終確認で入力事項が全て正しいか確認する。

※ 「ドメインを自動的に更新」の欄は確認しておく。

8. よければ「注文を完了」

![](/assets/posts/s3Https/domain04.png)

9. するとリクエストが送られる
10. コンソール上の「保留中のリクエスト」の欄で注文したドメインがあるか確認
11. しばらくすると登録したメールアドレスにAWSから認証メールが来る
  - メール内の認証用アドレスを開く
  - 認証成功の画面が表示されたらOK、閉じる
  - しばらくするとAWSから認証・登録完了のメールが来る
12. 注文したドメインが保留中のリクエストから「登録済みドメイン」に行くことを確認する

これで完了。
また、「ホストゾーン」の欄を開くと、ドメインのレコード等の編集が行える。

（ちなみにだが、この節に載せた写真はあくまで例として記載したまでなので、実際に購入はしてはいないことを補足しておく。）


# ACMで証明書を作成する

次に、AWSで認証局の役割を行ってくれるサービス「AWS Certificate Manager(ACM)」の設定を行う。

1. マネジメントコンソールからAWS Certificate Managerのページへ
2. リージョンを「 **us-east-1**(バージニア北部) 」に切り替えて作成する

※ 今回は後述のCloudFront、Lambda@edgeを利用する関係上、us-east-1リージョンで作成を行う。

3. 「証明書をリクエスト」へ

![](/assets/posts/s3Https/acm01.png)

4. 「パブリック証明書をリクエスト」へ

![](/assets/posts/s3Https/acm02.png)

5. [ドメイン名] に先ほど作成したドメイン名を入力。
6. 検証方法は DNS検証
7. その後「リクエスト」

![](/assets/posts/s3Https/acm03.png)

8. その後「証明書の一覧」画面でステータスが　保留中　で作成される
9. 証明書の一覧画面からその証明書を開く

![](/assets/posts/s3Https/acm04.png)

10. ドメイン　の欄で、「Route53でレコードを作成」を押下して作成
11. すると、Route53で作成したドメインにCNAMEレコードが作成される。
12. 発行済み　になるまで待つ

![](/assets/posts/s3Https/acm05.png)

これで証明書が作成される。

# CloudFrontでディストリビューションを作成する

次に、CloudFrontディストリビューションを作成して、静的Webサイトへのアクセス時に証明書を用いるように設定する。

1. マネジメントコンソールからCloudFrontのページへ
2. 「CloudFrontディストリビューションの作成」へ

![](/assets/posts/s3Https/cloudfront01.png)

3. その後、ディストリビューションの各設定を入力する。各設定項目は以下を入力する。

![](/assets/posts/s3Https/cloudfront02.png)

  - オリジンドメイン：作成したS3バケット
  - オリジンパス：空欄
  - 名前：オリジンドメイン入力したら自動で入る
  - S3バケットアクセス：Origin access conntrol settingsを選択
   - origin access control settings　コントロール設定を作成　で作る
   - 作成したらそれを選択
  - カスタムヘッダーを追加：空欄
  - オリジンシールドを有効にする：いいえ
  - ビューワープロトコルポリシー：Redirect HTTP to HTTPS
  - 許可されたHTTPメソッド：GET, HEAD
  - キャッシュポリシー：CachingOptimized
  - オリジンリクエストポリシー：空欄
  - レスポンスヘッダポリシー：空欄
  - 関数の関連づけ：なし
  - 料金クラス：全てのエッジロケーション
  - AWS WAF Web ACL：空欄
  - 代替ドメイン名(CNAME)：**ACMで設定した証明書を取得したドメイン名**
  - カスタムSSL証明書：ACMで作った証明書（ここの証明書は**us-east-1で作成しないと不可**）
  - サポートされているHTTPバージョン：HTTP/2
  - デフォルトルートオブジェクト：index.htmlなど（各自の環境に合わせて設定する）
  - 標準ログ記録：オフ
  - IPv6：オン

入力したら一番下の「ディストリビューションの作成」を押下して作成する

4. ディストリビューション作成後に、OACを適用するためにS3バケットポリシーを更新する。

S3の対象バケットに行って、バケットポリシーを以下で更新する。（これにより、静的WebサイトへのアクセスがCloudfront経由になるように限定される。S3に直接アクセスすると認証エラーとなる。）

```json
{
    "Version": "2008-10-17",
    "Id": "PolicyForCloudFrontPrivateContent",
    "Statement": [
        {
            "Sid": "AllowCloudFrontServicePrincipal",
            "Effect": "Allow",
            "Principal": {
                "Service": "cloudfront.amazonaws.com"
            },
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::<バケット名>/*",
            "Condition": {
                "StringEquals": {
                  "AWS:SourceArn": "arn:aws:cloudfront::<アカウントID>:distribution/<ディストリビューションID>"
                }
            }
        }
    ]
}
```

5. S3のCORS設定を追記する

また、S3対象バケットのアクセス許可　のセクションにあるCORSの設定に以下のJSONを設定する。

```json
[
    {
        "AllowedHeaders": [
            "*"
        ],
        "AllowedMethods": [
            "GET",
            "HEAD"
        ],
        "AllowedOrigins": [
            "*"
        ],
        "ExposeHeaders": []
    }
]
```

# Route53で独自ドメインのエイリアスの向き先を変更する

最後に、作成したドメインの向き先をCloudfrontに向ける。

1. マネジメントコンソールからRoute53へ

![](/assets/posts/s3Https/route53-01.png)

2. 「ホストゾーン」から作成・登録したホストゾーン(ドメイン)を開く
3. そこから「レコードの作成」へ
4. レコードタイプは　A
5. レコード名は各自自由に入力
6. エイリアスをONにして、　トラフィックのルーティング先　を「CloudFrontディストリビューションのエイリアス」に選択
7. 「ディストリビューションの選択」で、対象CloudFrontのディストリビューションドメイン名　を入力する
8. ルーティングは　シンプルルーティング　でとりあえず良い
9. それで　レコードを作成

![](/assets/posts/s3Https/route53-02.png)

10. また、CloudfrontディストリビューションがIPv6も有効になっているので、同様の手順でAAAAレコードも作成する。

これで作成したドメイン名のURLにアクセスすると、S3での静的webサイトが表示される（はず）。

次は、この静的Webサイトに認証機能を設けることを考えてみる。