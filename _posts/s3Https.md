---
title: 'ドメインを取得してS3(静的Webホスティング)をHTTPS化する'
excerpt: 'AWSでのドメイン取得方法・S3に立てたWebサイトをHTTPS化する手順'
coverImage: '/assets/posts/s3Https/httpsProcess.png'
date: '2023-02-14T23:03:11.000Z'
updatedAt: '2023-02-14T23:03:11.000Z'
tag: ["AWS","S3","ACM","CloudFront","HTTP","HTTPS","Route53","DNS","ドメイン"]
author:
  name: Tatsuroh Wakasugi
  picture: '/assets/blog/authors/WAT.jpg'
ogImage:
  url: ''
draft: false
---

前述の [S3に立てた静的Webサイト](/posts/s3StaticHost) の記事であるが、S3静的Webホスティングでサイトを建てた時、通常ではHTTPでのアクセス、表示となっている。

また、S3静的Webサイトホスティングを設定した場合、公開URLの形式は固定されている。

自分で設定したURLで公開したい場合、またHTTPS化して通信したいとなった時どうすれば良いか。今回はその実施を行ってみたので、そのための手順を留めておく。

# HTTPSとは

の前に、まずHTTPSとは何なんだろうか。

## HTTP

まず前提として、ユーザーがWebブラウザを通して、Webサイトのあるサーバからサイトのデータをやり取りするためのプロトコル(通信規則)として**HTTP** がある。

流れとしては、ユーザーがWebブラウザから指定したWebサイトを開こうとすると、そのWebサイトがあるWebサーバーにリクエストが送信される。Webサーバー側はそのリクエストを受信し、そのWebサイトを構成するデータ(htmlファイルなど)をユーザー側にレスポンスとして返す。そのレスポンスをWebブラウザが受け取り、Webサイトを表示するという仕組みになっている。

![](/assets/posts/s3Https/http.png)

## HTTPS

しかし、このHTTPでは、リクエストとレスポンスは暗号化されておらず、他の第三者が通信を傍受し、内容を覗き見るとどのようなデータが送られているかがわかってしまう状態になってしまう。

特に重大な情報を送ってないのであれば良いのだが、例えば決済を行うサイトの場合は自分のクレジットカード情報やパスワードだったり、個人情報を利用するサイトでは自分の個人情報を送るパターンもある。そのような場合、他の第三者に内容がわかってしまう状態で送るのは良くないだろう。

このような場合の対策として、HTTPに暗号化を施して送受信する仕組みが**HTTPS**である。HTTPSで送受信した場合、データが暗号化されるため、第三者に通信を傍受されても内容が解読できず読み取られない。

## HTTPSの設定

HTTPSを設定するためには何を用意すれば良いか。

HTTPSの暗号化設定は、**SSLサーバ証明書**を利用する事で実現できる。

SSLサーバ証明書とは、ユーザ(Webブラウザ)とWebサーバ間で通信の暗号化を行うための電子証明書であり、ユーザ・サーバとは別の外部の**認証局**から発行される。

認証局とは、対象のWebサイトの正当性を示すための第三者機関であり、Webサイトの審査を行い、正当性が確認できたら証明書の発行を行う。

このSSLサーバ証明書には、Webサイトの情報、及び暗号化に必要な鍵などのデータが含まれており、これを利用してHTTPS通信を行う。

![](/assets/posts/s3Https/certificate.png)

このうちの認証局について、実はAWSには認証局の役割を行えるサービス「**AWS Certificate Manager**」がある。今回はそちらを使用しつつ行っていく。

# ドメインとは

インターネットで言うドメインとは、いわゆるWeb上での住所のことを言う。

正確にはWeb上での住所のことは「IPアドレス」と言う数字列で示されるのだが、数字列だとわかりにくいため、人間がわかりやすいような文字列で置き換える(DNS と言う仕組みを用いる)ことが多い。この文字列がドメイン名である。

ちなみにこのブログは「wat-notes.com」と言うドメイン名を設定している。

このドメイン名だが、実は自由に設定できると言うわけではなく、世界で一意でなければならない。

また、ドメイン名の登録には料金がかかる。ドメイン名の登録や購買は専用のサービスがあるのでそちらを利用して行う。

ちなみにAWSでは、DNSの設定を行うサービス「Route 53」があるので、今回はこちらを使用する。また、このRoute53により、ドメイン名の登録・購入も行える。



# 大まかな手順

手順としては以下の通り。なおS3での静的Webホスティングは既に行われている前提である。
- Route53で独自ドメイン設定（別サービスでドメインを取得しているなら飛ばす）
- ACMで証明書を作成する
- CloudFrontでディストリビューションを作成し、S3の静的Webサイトと結びつけ、また証明書も適用する

# Route53でドメインを取得する

事前に、HTTPS化に必要なドメイン名の登録を行っておく。

- マネジメントコンソールからRoute53のページへ
- 「ドメインの登録」へ
- ドメイン名と、トップレベルドメインを入力する
- 「チェック」を押して、登録可能か確認する
- 決めたら「カートに入れる」を押して「続行」
- 「ドメインのお問い合わせ」で連絡先を書く
- 最終確認で入力事項が全て正しいか確認する。
  - 「ドメインを自動的に更新」の欄は確認しておく。
- よければ「注文を完了」
- するとリクエストが送られる
- 「保留中のリクエスト」の欄で注文したドメインがあるか確認
- しばらくすると登録したメールアドレスにAWSから認証メールが来る
  - メール内の認証用アドレスを開く
  - 認証成功の画面が表示されたらOK、閉じる
  - しばらくするとAWSから認証・登録完了のメールが来る
- 注文したドメインが保留中のリクエストから「登録済みドメイン」に行くことを確認する

これで完了。
また、「ホストゾーン」の欄を開くと、ドメインのレコード等の編集が行える。



# ACMで証明書を作成する

- マネジメントコンソールからAWS Certificate Managerのページへ
- 「証明書をリクエスト」へ
- 「パブリック証明書をリクエスト」へ
- [ドメイン名] にhttps化対象のドメイン名を入力。（ここではnote3.wat.blog）とした
- 検証方法は DNS検証
- それでリクエスト
- その後証明書の一覧画面でステータスが　保留中　になる

- 一覧画面からその証明書を開く
- ドメイン　の欄で、「Route53でレコードを作成」を押下して作成
- すると、Route53で作成したドメインにCNAMEレコードが作成される。

- 発行済み　になるまで待つ

これで証明書が作成される。

# CloudFrontでディストリビューションを作成する

- マネジメントコンソールからCloudFrontのページへ
- 「CloudFrontディストリビューションの作成」へ
- 入力項目は以下で
  - オリジンドメイン　は作成したS3バケット
  - オリジンパス　空欄
  - 名前　オリジンドメイン入力したら自動で入る
  - S3バケットアクセス　orrigin access conntrol settings　コントロール設定を作成　で作る
   - 作成したらそれを選択
  - カスタムヘッダーを追加　ここは空欄
  - オリジンシールドを有効にする　とりあえず　いいえ
  - ビューワープロトコルポリシー　Redirect HTTP to HTTPS
  - 許可されたHTTPメソッド　GET, HEAD
  - キャッシュポリシー　CachingOptimized？
  - オリジンリクエストポリシー　空欄？
  - レスポンスヘッダポリシー　空欄？
  - 関数の関連づけ　とりあえずなし
  - 料金クラス　全てのエッジロケーション
  - AWS WAF Web ACL 空欄
  - 代替ドメイン名(CNAME)　**ACMで設定した証明書を取得したドメイン名**
  - カスタムSSL証明書　ACMで作った証明書？　なお証明書は**us-east-1で作らないといけないらしい・・**
  - サポートされているHTTPバージョン　HTTP/2
  - デフォルトルートオブジェクト　index.html あとで変えよう
  - 標準ログ記録　オフ
  - IPv6 オン

で「ディストリビューションの作成」へ

作成後に、OACを適用するためにS3バケットポリシーを更新する必要がある。
S3の対象バケットに行って、バケットポリシーを以下で更新しておく。

```json
{
    "Version": "2008-10-17",
    "Id": "PolicyForCloudFrontPrivateContent",
    "Statement": [
        {
            "Sid": "AllowCloudFrontServicePrincipal",
            "Effect": "Allow",
            "Principal": {
                "Service": "cloudfront.amazonaws.com"
            },
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::<バケット名>/*",
            "Condition": {
                "StringEquals": {
                  "AWS:SourceArn": "arn:aws:cloudfront::<アカウントID>:distribution/<ディストリビューションID>"
                }
            }
        }
    ]
}
```

# Route53で独自ドメインのエイリアスの向き先を変更する

最後に、作成したドメインの向き先をCloudfrontに向ける。

- マネジメントコンソールからRoute53へ
- Route53から「レコードの作成」へ
- レコードタイプは　A
- レコード名は各自自由に入力
- エイリアスをONにして、　トラフィックのルーティング先　を「CloudFrontディストリビューションのエイリアス」に選択
- 「ディストリビューションの選択」で、対象CloudFrontのディストリビューションドメイン名　を入力する
- ルーティングは　シンプルルーティング　でとりあえず良い
- それで　レコードを作成

- また、CloudfrontディストリビューションがIPv6も有効になっているので、同様の手順でAAAAレコードも作成する。

