---
title: 'ドメインを取得してS3(静的Webホスティング)をHTTPS化する'
excerpt: 'AWSでのドメイン取得方法・S3に立てたWebサイトをHTTPS化する手順'
coverImage: ''
date: '2023-02-16T22:29:57.000Z'
updatedAt: '2023-02-16T22:29:57.000Z'
tag: ["AWS","S3","ACM","CloudFront","HTTPS","Route53","DNS","ドメイン"]
author:
  name: Tatsuroh Wakasugi
  picture: '/assets/blog/authors/WAT.jpg'
ogImage:
  url: ''
draft: true
---

前述の S3に立てた静的Webサイト だが、通常ではHTTPでの表示となっている。

これをHTTPS化する手順をここに留めておく。

# 大まかな手順

手順としては以下の通り。なおS3での静的Webホスティングは既に行われている前提である。
- Route53で独自ドメイン設定（別サービスでドメインを取得しているなら飛ばす）
- ACMで証明書を作成する
- CloudFrontでディストリビューションを作成する

# Route53でドメインを取得する

事前に、HTTPS化に必要なドメイン名の登録を行っておく。

- マネジメントコンソールからRoute53のページへ
- 「ドメインの登録」へ
- ドメイン名と、トップレベルドメインを入力する
- 「チェック」を押して、登録可能か確認する
- 決めたら「カートに入れる」を押して「続行」
- 「ドメインのお問い合わせ」で連絡先を書く
- 最終確認で入力事項が全て正しいか確認する。
  - 「ドメインを自動的に更新」の欄は確認しておく。
- よければ「注文を完了」
- するとリクエストが送られる
- 「保留中のリクエスト」の欄で注文したドメインがあるか確認
- しばらくすると登録したメールアドレスにAWSから認証メールが来る
  - メール内の認証用アドレスを開く
  - 認証成功の画面が表示されたらOK、閉じる
  - しばらくするとAWSから認証・登録完了のメールが来る
- 注文したドメインが保留中のリクエストから「登録済みドメイン」に行くことを確認する

これで完了。
また、「ホストゾーン」の欄を開くと、ドメインのレコード等の編集が行える。



# ACMで証明書を作成する

- マネジメントコンソールからAWS Certificate Managerのページへ
- 「証明書をリクエスト」へ
- 「パブリック証明書をリクエスト」へ
- [ドメイン名] にhttps化対象のドメイン名を入力。（ここではnote3.wat.blog）とした
- 検証方法は DNS検証
- それでリクエスト
- その後証明書の一覧画面でステータスが　保留中　になる

- 一覧画面からその証明書を開く
- ドメイン　の欄で、「Route53でレコードを作成」を押下して作成
- すると、Route53で作成したドメインにCNAMEレコードが作成される。

- 発行済み　になるまで待つ

これで証明書が作成される。

# CloudFrontでディストリビューションを作成する

- マネジメントコンソールからCloudFrontのページへ
- 「CloudFrontディストリビューションの作成」へ
- 入力項目は以下で
  - オリジンドメイン　は作成したS3バケット
  - オリジンパス　空欄
  - 名前　オリジンドメイン入力したら自動で入る
  - S3バケットアクセス　orrigin access conntrol settings　コントロール設定を作成　で作る
   - 作成したらそれを選択
  - カスタムヘッダーを追加　ここは空欄
  - オリジンシールドを有効にする　とりあえず　いいえ
  - ビューワープロトコルポリシー　Redirect HTTP to HTTPS
  - 許可されたHTTPメソッド　GET, HEAD
  - キャッシュポリシー　CachingOptimized？
  - オリジンリクエストポリシー　空欄？
  - レスポンスヘッダポリシー　空欄？
  - 関数の関連づけ　とりあえずなし
  - 料金クラス　全てのエッジロケーション
  - AWS WAF Web ACL 空欄
  - 代替ドメイン名(CNAME)　**ACMで設定した証明書を取得したドメイン名**
  - カスタムSSL証明書　ACMで作った証明書？　なお証明書は**us-east-1で作らないといけないらしい・・**
  - サポートされているHTTPバージョン　HTTP/2
  - デフォルトルートオブジェクト　index.html あとで変えよう
  - 標準ログ記録　オフ
  - IPv6 オン

で「ディストリビューションの作成」へ

作成後に、OACを適用するためにS3バケットポリシーを更新する必要がある。
S3の対象バケットに行って、バケットポリシーを以下で更新しておく。

```json
{
    "Version": "2008-10-17",
    "Id": "PolicyForCloudFrontPrivateContent",
    "Statement": [
        {
            "Sid": "AllowCloudFrontServicePrincipal",
            "Effect": "Allow",
            "Principal": {
                "Service": "cloudfront.amazonaws.com"
            },
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::<バケット名>/*",
            "Condition": {
                "StringEquals": {
                  "AWS:SourceArn": "arn:aws:cloudfront::<アカウントID>:distribution/<ディストリビューションID>"
                }
            }
        }
    ]
}
```

# Route53で独自ドメインのエイリアスの向き先を変更する

最後に、作成したドメインの向き先をCloudfrontに向ける。

- マネジメントコンソールからRoute53へ
- Route53から「レコードの作成」へ
- レコードタイプは　A
- レコード名は各自自由に入力
- エイリアスをONにして、　トラフィックのルーティング先　を「CloudFrontディストリビューションのエイリアス」に選択
- 「ディストリビューションの選択」で、対象CloudFrontのディストリビューションドメイン名　を入力する
- ルーティングは　シンプルルーティング　でとりあえず良い
- それで　レコードを作成

- また、CloudfrontディストリビューションがIPv6も有効になっているので、同様の手順でAAAAレコードも作成する。

